<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
    <script src="/static/js/common/constants/SocketEvents.js"></script>
    <script src="/static/js/common/constants/CallState.js"></script>
    <script src="/static/js/common/constants/CallType.js"></script>
    <script src="/static/js/common/constants/Constants.js"></script>
    <script src="/static/js/common/constants/CallElements.js"></script>
    <script src="/static/js/core/classes/CallEventListener.js"></script>
    <script src="/static/js/core/classes/User.js"></script>
    <script src="/static/js/core/classes/CallPayload.js"></script>
    <script src="/static/js/core/classes/CallClient.js"></script>
    <script>

        const { RTCPeerConnection, RTCSessionDescription } = window;
        const socket = io();

        socket.onAny((e, d) => console.log(e, d));

        class Application {
            static instance = null;
            static getInstance = () => {
                return Application.instance;
            }
            constructor() {
                if (Application.instance) throw Error("Can't create more than one instance of Application");
                this.callClient = new CallClient(socket);
                this.localVideoStream = null;
                this.remoteVideoStream = null;

                this.peerConnection = new RTCPeerConnection(Constants.WEBRTC_PEER_CONFIGURATION);
                this.initConnection();
            }

            initConnection() {
                this.peerConnection.onnegotiationneeded = e => {
                    if (this.peerConnection.signalingState != "stable") return;
                }
                
                this.peerConnection.ontrack = (event) => {
                    const remoteVideo = document.getElementById(CallElements.remoteVideo);
                    if (remoteVideo) {
                        remoteVideo.srcObject = event.streams[0];
                    }
                    this.callClient.markCallAsReady();
                };

                this.peerConnection.onicecandidate = (event) => { 
                    if (event.candidate) { 
                        this.callClient.sendCandidate(event.candidate);
                    } 
                }
            }

            loginWithToken = (token) => {
                this.callClient.login(id);
            }

            loginWithId = (id) => {
                this.callClient.login(id);
                document.querySelector("#userId").innerHTML = id;
            }

            initMediaObjects = async () => {
                this.localVideoStream = await navigator.mediaDevices.getUserMedia(Constants.VIDEO_CONSTRAINTS);
                console.log(this.localVideoStream.getTracks());
                const localVideo = document.getElementById(CallElements.localVideo);
                localVideo.srcObject = this.localVideoStream;
                const tracks = this.localVideoStream.getTracks();
                tracks.forEach(track => {
                    this.peerConnection.addTrack(track, this.localVideoStream)
                })
            }

            registerElements = () => {
                this.callButtons = {
                    accept: document.querySelector("#"+ CallElements.buttonAcceptCall),
                    reject: document.querySelector("#"+ CallElements.buttonRejectCall),
                    start: document.querySelector("#"+ CallElements.buttonStartCall),
                    end: document.querySelector("#"+ CallElements.buttonEndCall),
                    toggleMic: document.querySelector("#"+ CallElements.buttonToggleMic),
                    toggleCamera: document.querySelector("#"+ CallElements.buttonToggleCamera),
                }
            }

            registerFunctions = () => {
                this.callButtons.start.addEventListener("click", ()=>{
                    let calleeId = document.querySelector("#calleeId").value;
                    this.callClient.createCall({
                        userId: calleeId,
                        userName: "Nguyen Van A",
                        userAvatar: "123123"
                    }, CallType.VIDEO);
                })
                this.callButtons.accept.addEventListener("click", ()=>{
                    this.callClient.acceptCall();
                })
                this.callButtons.reject.addEventListener("click", ()=>{
                    this.callClient.rejectCall();
                })
                this.callButtons.end.addEventListener("click", ()=>{
                    this.callClient.endCall();
                })
                this.callButtons.toggleMic.addEventListener("click", ()=>{
                    this.toggleMic();
                })
                this.callButtons.toggleCamera.addEventListener("click", ()=>{
                    this.toggleCamera();
                })
            }

            hideElement = (elem) => {
                elem.classList.add("hidden");
            }

            showElement = (elem) => {
                elem.classList.remove("hidden");
            }

            createOffer = async () => {
                const offer = await this.peerConnection.createOffer();
                console.log("createOffer", offer);
                await this.peerConnection.setLocalDescription(new RTCSessionDescription(offer));
                return offer;
            }

            createAnswer = async (webrtcOffer) => {
                console.log("createAnswer", webrtcOffer);
                await this.peerConnection.setRemoteDescription(
                    new RTCSessionDescription(webrtcOffer)
                );
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(new RTCSessionDescription(answer));
                return answer;
            }

            onReceiveAnswer = async (answer) => {
                console.log("onReceiveAnswer", answer);
                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            }

            addIceCandidate = async (iceCandidate) => {
                this.peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate));
            }

            resetCall = () => {
                const remoteVideo = document.getElementById(CallElements.remoteVideo);
                if (remoteVideo) {
                    remoteVideo.srcObject = null;
                }
            }

            changeCameraStatus(enabled) {
                const tracks = this.localVideoStream.getVideoTracks();
                tracks.forEach(track => {
                    track.enabled = enabled;
                });
            }

            changeMicStatus(enabled) {
                const tracks = this.localVideoStream.getAudioTracks();
                tracks.forEach(track => {
                    track.enabled = enabled;
                })
            }

            toggleCamera() {
                const enabled = !this.callClient.videoStatus;
                this.callClient.changeCameraStatus(enabled);
            }

            toggleMic() {
                const enabled = !this.callClient.audioStatus;
                this.callClient.changeMicStatus(enabled);
            }
        }

        window.onload = () => {
            const URL_PARAMS = new URLSearchParams(window.location.search);
            const CALLEE_ID = URL_PARAMS.get("calleeId");
            const USER_ID = URL_PARAMS.get("userId");
            const CALL_TYPE = URL_PARAMS.get("callType");
            const JOIN_AS = URL_PARAMS.get("joinAs");
            const ACCESS_TOKEN = URL_PARAMS.get("token");

            Application.instance = new Application();
            let app = Application.getInstance();
            app.registerElements();
            app.callClient.addCallStateListener((state) => {
                if (state == CallState.CALLING||state == CallState.CONNECTING) {
                    app.hideElement(app.callButtons.accept);
                    app.hideElement(app.callButtons.reject);
                    app.showElement(app.callButtons.end);
                } else {
                    app.showElement(app.callButtons.accept);
                    app.showElement(app.callButtons.reject);
                    app.hideElement(app.callButtons.end);
                }
                console.log("callState", state);
            })

            app.initMediaObjects().then(()=>{
                app.loginWithId(USER_ID);
                app.registerFunctions();
            })
        }
    </script>
    <style>
        * {
            margin: 0px;
        }

        .hidden  {
            display: none;
        }

        .callarea {
            .callarea__video {
                position: relative;
                width: 50vw;
                height: 50vh;
                border: 1px solid black;

                .callarea__video__remote {
                    position: absolute;
                    top: 0px;
                    left: 0px;
                    width: 100%;
                    height: 100%;
                }
                .callarea__video__local {
                    position: absolute;
                    bottom: 0px;
                    right: 0px;
                    width: 25%;
                    height: 25%;
                }
            }
        }
        
    </style>

</head>
<body>
    <section class="main">
        <div class="callarea">
            <div class="callarea__video">
                <video class="callarea__video__remote" id="callclient__remote_video_stream" autoplay muted></video>
                <video class="callarea__video__local" id="callclient__local_video_stream" autoplay muted></video>
            </div>
        </div>
    </section>
    <div>
        <p id="userId"></p>
        <input id="calleeId" type="text">
        <button id="callclient__button_start_call">Call</button>
        <button id="callclient__button_accept_call">Accept</button>
        <button id="callclient__button_reject_call">Reject</button>
        <button id="callclient__button_end_call" class="hidden">End call</button>
        <button id="callclient__button_toggle_camera">Toggle camera</button>
        <button id="callclient__button_toggle_mic">Toggle mic</button>
    </div>
</body>
</html>